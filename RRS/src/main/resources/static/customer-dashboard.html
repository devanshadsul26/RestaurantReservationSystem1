<!DOCTYPE html>
<html>
<head>
    <title>Customer Dashboard</title>
</head>
<body>
<h1>Customer Dashboard</h1>

<div id="welcome"></div>

<h2>Make a Reservation</h2>
<form id="bookingForm">
    <label>Date: <input type="date" id="date" required></label><br>
    <label>Time: <input type="time" id="time" required></label><br>
    <label>Guests: <input type="number" id="guestCount" min="1" max="50" required></label><br>
    <label>Location:
        <select id="locationPreference">
            <option value="">Any</option>
            <option value="Indoor">Indoor</option>
            <option value="Outdoor">Outdoor</option>
        </select>
    </label><br>
    <label>Special Requests:
        <textarea id="specialRequests"></textarea>
    </label><br>
    <p>Availability: <span id="availabilityStatus">-</span></p>
    <button type="submit">Book</button>
</form>

<h2>Your Reservations</h2>
<table border="1" id="reservationsTable">
    <thead>
    <tr>
        <th>ID</th><th>Date</th><th>Time</th><th>Guests</th><th>Status</th><th>Action</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<p id="message" style="color:green;"></p>
<p id="error" style="color:red;"></p>

<script>
    const customerId = localStorage.getItem('customerId');
    if (!customerId) {
        window.location.href = '/customer-login.html';
    }

    // show welcome text
    document.getElementById('welcome').textContent = 'Logged in as customer #' + customerId;

    // helper: check availability
    async function checkAvailability() {
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const guestCount = document.getElementById('guestCount').value;
        const location = document.getElementById('locationPreference').value;

        if (!date || !time || !guestCount) {
            document.getElementById('availabilityStatus').textContent = '-';
            return;
        }

        const params = new URLSearchParams({
            date,
            time,
            guestCount,
            locationPreference: location
        });

        const res = await fetch('/api/availability/check?' + params.toString());
        const data = await res.json();
        document.getElementById('availabilityStatus').textContent =
            data.available ? 'Available' : 'Not available';
    }

    // trigger availability when fields change
    ['date','time','guestCount','locationPreference'].forEach(id => {
        document.getElementById(id).addEventListener('change', checkAvailability);
    });

    // submit booking
    document.getElementById('bookingForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        document.getElementById('message').textContent = '';
        document.getElementById('error').textContent = '';

        const body = {
            customerId: parseInt(customerId),
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            guestCount: parseInt(document.getElementById('guestCount').value),
            locationPreference: document.getElementById('locationPreference').value,
            specialRequests: document.getElementById('specialRequests').value
        };

        const res = await fetch('/api/reservations/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });

        const data = await res.json();

        if (!res.ok) {
            document.getElementById('error').textContent = data.message || 'Booking failed';
        } else {
            document.getElementById('message').textContent =
                'Reservation created. ID = ' + data.reservationId +
                ', status = ' + data.status;
            loadReservations();
        }
    });

    // load reservations for this customer
    async function loadReservations() {
        const res = await fetch('/api/reservations?customerId=' + customerId);
        const data = await res.json();
        const tbody = document.querySelector('#reservationsTable tbody');
        tbody.innerHTML = '';

        data.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.id}</td>
                <td>${r.reservationDate}</td>
                <td>${r.reservationTime}</td>
                <td>${r.guestCount}</td>
                <td>${r.status}</td>
                <td>
                    ${r.status === 'Confirmed' || r.status === 'Pending Confirmation'
                        ? '<button data-id="'+r.id+'">Cancel</button>'
                        : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });

        // attach cancel handlers
        document.querySelectorAll('#reservationsTable button').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                const res = await fetch('/api/reservations/' + id, { method: 'DELETE' });
                if (res.ok) {
                    loadReservations();
                }
            });
        });
    }

    // initial load
    loadReservations();
</script>
</body>
</html>
